<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Fuseau (fuseau.Fuseau)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../_odoc-theme/odoc.css"/><meta name="generator" content="odoc 2.4.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../index.html">fuseau</a> &#x00BB; Fuseau</nav><header class="odoc-preamble"><h1>Module <code><span>Fuseau</span></code></h1><p>Fuseau core.</p><p>The core library contains the definition of the main scheduler, fibers, switches, and other foundations for cooperative structured concurrency.</p></header><nav class="odoc-toc"><ul><li><a href="#foundations">Foundations</a></li><li><a href="#synchronization">Synchronization</a></li><li><a href="#utils">Utils</a></li><li><a href="#io-event-loop">IO event loop</a></li><li><a href="#resource-management">Resource management</a></li><li><a href="#io">IO</a></li><li><a href="#sleep">Sleep</a></li><li><a href="#re-exports">Re-exports</a></li><li><a href="#main-loop.">Main loop.</a></li></ul></nav><div class="odoc-content"><h3 id="foundations"><a href="#foundations" class="anchor"></a>Foundations</h3><div class="odoc-spec"><div class="spec module anchored" id="module-Fiber_handle"><a href="#module-Fiber_handle" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Fiber_handle/index.html">Fiber_handle</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>The unique name of a fiber</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Event"><a href="#module-Event" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Event/index.html">Event</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Atomic events.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-branch"><a href="#type-branch" class="anchor"></a><code><span><span class="keyword">type</span> <span>'ret branch</span></span><span> = <span><span class="type-var">'ret</span> <a href="Event/index.html#type-branch">Event.branch</a></span></span><span> = </span></code><ol><li id="type-branch.When" class="def variant constructor anchored"><a href="#type-branch.When" class="anchor"></a><code><span>| </span><span><span class="constructor">When</span> : <span><span class="type-var">'a</span> <a href="Event/index.html#type-t">Event.t</a></span> * <span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'ret</span>)</span> <span class="arrow">&#45;&gt;</span> <span><span class="type-var">'ret</span> <a href="#type-branch">branch</a></span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-select"><a href="#val-select" class="anchor"></a><code><span><span class="keyword">val</span> select : <span><span><span><span class="type-var">'ret</span> <a href="#type-branch">branch</a></span> list</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'ret</span></span></code></div><div class="spec-doc"><p>See <a href="Event/index.html#val-select"><code>Event.select</code></a>.</p></div></div><h3 id="synchronization"><a href="#synchronization" class="anchor"></a>Synchronization</h3><div class="odoc-spec"><div class="spec module anchored" id="module-Chan"><a href="#module-Chan" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Chan/index.html">Chan</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Basic channels</p></div></div><h3 id="utils"><a href="#utils" class="anchor"></a>Utils</h3><div class="odoc-spec"><div class="spec module anchored" id="module-Exn_bt"><a href="#module-Exn_bt" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Exn_bt/index.html">Exn_bt</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Exception with backtrace</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Time"><a href="#module-Time" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Time/index.html">Time</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Time measurement</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Fiber"><a href="#module-Fiber" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Fiber/index.html">Fiber</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Fibers.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-FLS"><a href="#module-FLS" class="anchor"></a><code><span><span class="keyword">module</span> <a href="FLS/index.html">FLS</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Fiber-local storage.</p></div></div><h3 id="io-event-loop"><a href="#io-event-loop" class="anchor"></a>IO event loop</h3><div class="odoc-spec"><div class="spec exception anchored" id="exception-Inactive"><a href="#exception-Inactive" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Inactive</span></span></code></div><div class="spec-doc"><p>Exception raised when trying to perform operations on the scheduler after it's been disposed of</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Scheduler"><a href="#module-Scheduler" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Scheduler/index.html">Scheduler</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Scheduler that runs fibers.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Event_loop"><a href="#module-Event_loop" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Event_loop/index.html">Event_loop</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Abstraction over an event loop, from the pov of the scheduler.</p></div></div><h3 id="resource-management"><a href="#resource-management" class="anchor"></a>Resource management</h3><div class="odoc-spec"><div class="spec module anchored" id="module-Resource_pool"><a href="#module-Resource_pool" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Resource_pool/index.html">Resource_pool</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Resource pool.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Buf_pool"><a href="#module-Buf_pool" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Buf_pool/index.html">Buf_pool</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>A pool of buffers to reuse.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Cancel_handle"><a href="#module-Cancel_handle" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Cancel_handle/index.html">Cancel_handle</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>Cancelation handle.</p></div></div><h3 id="io"><a href="#io" class="anchor"></a>IO</h3><div class="odoc-spec"><div class="spec module anchored" id="module-Iostream"><a href="#module-Iostream" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Iostream/index.html">Iostream</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><h3 id="sleep"><a href="#sleep" class="anchor"></a>Sleep</h3><div class="odoc-spec"><div class="spec value anchored" id="val-sleep_s"><a href="#val-sleep_s" class="anchor"></a><code><span><span class="keyword">val</span> sleep_s : <span>float <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Put the current fiber to sleep for the amount of seconds.</p></div></div><h3 id="re-exports"><a href="#re-exports" class="anchor"></a>Re-exports</h3><div class="odoc-spec"><div class="spec exception anchored" id="exception-Timeout"><a href="#exception-Timeout" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Timeout</span></span></code></div><div class="spec-doc"><p>Exception used for cancellation caused by timeout</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-await"><a href="#val-await" class="anchor"></a><code><span><span class="keyword">val</span> await : <span><span><span class="type-var">'a</span> <a href="Fiber/index.html#type-t">Fiber.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p>Wait for the fiber to terminate, and return the result. If the fiber failed, this re-raises the exception.</p><p>This must be called from inside another fiber, which will be suspended if needed.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-try_await"><a href="#val-try_await" class="anchor"></a><code><span><span class="keyword">val</span> try_await : <span><span><span class="type-var">'a</span> <a href="Fiber/index.html#type-t">Fiber.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="Exn_bt/index.html#type-result">Exn_bt.result</a></span></span></code></div><div class="spec-doc"><p>Like <a href="#val-await"><code>await</code></a> but catches exceptions.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cancel_after_s"><a href="#val-cancel_after_s" class="anchor"></a><code><span><span class="keyword">val</span> cancel_after_s : <span>float <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Cancel the current fiber after <code>delay</code> seconds, unless the fiber terminates first. The cancellation will use the <a href="#exception-Timeout"><code>Timeout</code></a> exception.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ev_timeout"><a href="#val-ev_timeout" class="anchor"></a><code><span><span class="keyword">val</span> ev_timeout : <span>float <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="Event/index.html#type-t">Event.t</a></span></span></code></div><div class="spec-doc"><p><code>ev_timeout duration</code> is an event that resolves after <code>duration</code> seconds with a <code>Error Timeout</code> error</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ev_deadline"><a href="#val-ev_deadline" class="anchor"></a><code><span><span class="keyword">val</span> ev_deadline : <span>float <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="Event/index.html#type-t">Event.t</a></span></span></code></div><div class="spec-doc"><p><code>ev_deadline time</code> is an event that resolves at monotonic time <code>t</code> with a <code>Error Timeout</code> error</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_cancel_callback"><a href="#val-with_cancel_callback" class="anchor"></a><code><span><span class="keyword">val</span> with_cancel_callback : <span><span>(<span><a href="Exn_bt/index.html#type-t">Exn_bt.t</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>let@ () = with_cancel_callback cb in &lt;e&gt;</code> evaluates <code>e</code> in a scope in which, if the current fiber is cancelled, <code>cb()</code> is called. If <code>e</code> returns without the fiber being cancelled, this callback is removed.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-spawn"><a href="#val-spawn" class="anchor"></a><code><span><span class="keyword">val</span> spawn : 
  <span><span class="optlabel">?name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?propagate_cancel_to_parent</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <a href="Fiber/index.html#type-t">Fiber.t</a></span></span></code></div><div class="spec-doc"><p>Must be run from inside the scheduler's thread. Spawn a new computation. This fiber has an implicit parent, which is normally the currently running fiber (the one calling <a href="#val-spawn"><code>spawn</code></a>). If the parent fails or is cancelled, the resulting fiber will also be cancelled (parent to child).</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">propagate_cancel_to_parent</span> <p>if true (the default), if this fiber fails then the parent fiber will also fail (child to parent).</p></li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <a href="#exception-Inactive"><code>Inactive</code></a> <p>if the scheduler is inactive.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-spawn_from_anywhere"><a href="#val-spawn_from_anywhere" class="anchor"></a><code><span><span class="keyword">val</span> spawn_from_anywhere : 
  <span><span class="optlabel">?name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><a href="Scheduler/index.html#type-t">Scheduler.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <a href="Fiber/index.html#type-t">Fiber.t</a></span></span></code></div><div class="spec-doc"><p>Spawn a task from anywhere, possibly from another thread. The task will run in a subsequent call to <code>run_iteration</code> in the scheduler's thread. Thread-safe, more costly than <a href="#val-spawn"><code>spawn</code></a>. Runs under the root switch.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <a href="#exception-Inactive"><code>Inactive</code></a> <p>if the scheduler is inactive.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-spawn_as_child_of"><a href="#val-spawn_as_child_of" class="anchor"></a><code><span><span class="keyword">val</span> spawn_as_child_of : 
  <span><span class="optlabel">?name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?propagate_cancel_to_parent</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="Scheduler/index.html#type-t">Scheduler.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">_</span> <a href="Fiber/index.html#type-t">Fiber.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <a href="Fiber/index.html#type-t">Fiber.t</a></span></span></code></div><div class="spec-doc"><p>Spawn a fiber in the given parent fiber's scope. See <a href="#val-spawn"><code>spawn</code></a> for more details on the arguments</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-schedule_micro_task"><a href="#val-schedule_micro_task" class="anchor"></a><code><span><span class="keyword">val</span> schedule_micro_task : <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Must be run from inside a <a href="Scheduler/index.html#type-t"><code>Scheduler.t</code></a>'s thread. Schedules a microtask that will run in this tick. Be careful not to create infinite sequences of micro tasks that starve the IO loop!</p><p>These microtasks do not handle effects and should try their best to not raise exceptions. Only use them for very short amount of work.</p><p>Not thread-safe.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <a href="#exception-Inactive"><code>Inactive</code></a> <p>if the scheduler is inactive.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-yield"><a href="#val-yield" class="anchor"></a><code><span><span class="keyword">val</span> yield : <span>unit <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>yield ()</code> returns control to the scheduler and checks for cancellation. This must be called from a fiber.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_scheduler"><a href="#val-get_scheduler" class="anchor"></a><code><span><span class="keyword">val</span> get_scheduler : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="Scheduler/index.html#type-t">Scheduler.t</a></span></code></div><div class="spec-doc"><p>This returns the scheduler on which the caller runs. It must be called from inside a fiber.</p></div></div><h3 id="main-loop."><a href="#main-loop." class="anchor"></a>Main loop.</h3><p>This is the loop that runs both fibers, and the IO event loop, in an interspersed way.</p><div class="odoc-spec"><div class="spec value anchored" id="val-main"><a href="#val-main" class="anchor"></a><code><span><span class="keyword">val</span> main : <span><span class="label">loop</span>:<a href="Event_loop/class-type-t/index.html">Event_loop.t</a> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>main f</code> runs <code>f()</code> in an event loop. The value is returned when the loop has nothing else to do, even if the particular computation was finished earlier.</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">loop</span> <p>if provided, this event loop is used during the computation.</p></li></ul></div></div></div></body></html>
