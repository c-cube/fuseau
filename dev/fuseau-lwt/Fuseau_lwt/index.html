<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"><head><title>Fuseau_lwt (fuseau-lwt.Fuseau_lwt)</title><meta charset="utf-8"/><link rel="stylesheet" href="../../_odoc-theme/odoc.css"/><meta name="generator" content="odoc 2.4.1"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><script src="../../highlight.pack.js"></script><script>hljs.initHighlightingOnLoad();</script></head><body class="odoc"><nav class="odoc-nav"><a href="../index.html">Up</a> â€“ <a href="../index.html">fuseau-lwt</a> &#x00BB; Fuseau_lwt</nav><header class="odoc-preamble"><h1>Module <code><span>Fuseau_lwt</span></code></h1><p>Interoperability between Fuseau and Lwt.</p><p>This combines <a href="../../fuseau/Fuseau/index.html"><code>Fuseau</code></a>'s fibers with the Lwt event loop (ie <a href="../../lwt/Lwt_engine/index.html"><code>Lwt_engine</code></a>) to deal with timers and file descriptors readiness. In essence, one can use fibers and structured concurrency from <code>Fuseau</code> alongside Lwt libraries and Lwt IO operations.</p></header><nav class="odoc-toc"><ul><li><a href="#re-export-of-fuseau">Re-export of fuseau</a></li><li><a href="#interop">Interop</a></li><li><a href="#main-loop">Main loop</a></li></ul></nav><div class="odoc-content"><h3 id="re-export-of-fuseau"><a href="#re-export-of-fuseau" class="anchor"></a>Re-export of fuseau</h3><div class="odoc-include"><details open="open"><summary class="spec include"><code><span><span class="keyword">include</span> <span class="keyword">module</span> <span class="keyword">type</span> <span class="keyword">of</span> <span class="keyword">struct</span> <span class="keyword">include</span> <a href="../../fuseau/Fuseau/index.html">Fuseau</a> <span class="keyword">end</span></span></code></summary><h3 id="foundations"><a href="#foundations" class="anchor"></a>Foundations</h3><div class="odoc-spec"><div class="spec module anchored" id="module-Fiber_handle"><a href="#module-Fiber_handle" class="anchor"></a><code><span><span class="keyword">module</span> Fiber_handle</span><span> = <a href="../../fuseau/Fuseau/Fiber_handle/index.html">Fuseau.Fiber_handle</a></span></code></div><div class="spec-doc"><p>The unique name of a fiber</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Event"><a href="#module-Event" class="anchor"></a><code><span><span class="keyword">module</span> Event</span><span> = <a href="../../fuseau/Fuseau/Event/index.html">Fuseau.Event</a></span></code></div><div class="spec-doc"><p>Atomic events.</p></div></div><div class="odoc-spec"><div class="spec type anchored" id="type-branch"><a href="#type-branch" class="anchor"></a><code><span><span class="keyword">type</span> <span>'ret branch</span></span><span> = <span><span class="type-var">'ret</span> <a href="../../fuseau/Fuseau/Event/index.html#type-branch">Event.branch</a></span></span><span> = </span></code><ol><li id="type-branch.When" class="def variant constructor anchored"><a href="#type-branch.When" class="anchor"></a><code><span>| </span><span><span class="constructor">When</span> : <span><span class="type-var">'a</span> <a href="../../fuseau/Fuseau/Event/index.html#type-t">Event.t</a></span> * <span>(<span><span class="type-var">'a</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'ret</span>)</span> <span class="arrow">&#45;&gt;</span> <span><span class="type-var">'ret</span> <a href="#type-branch">branch</a></span></span></code></li></ol></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-select"><a href="#val-select" class="anchor"></a><code><span><span class="keyword">val</span> select : <span><span><span><span class="type-var">'ret</span> <a href="#type-branch">branch</a></span> list</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'ret</span></span></code></div><div class="spec-doc"><p>See <a href="../../fuseau/Fuseau/Event/index.html#val-select"><code>Event.select</code></a>.</p></div></div><h3 id="synchronization"><a href="#synchronization" class="anchor"></a>Synchronization</h3><div class="odoc-spec"><div class="spec module anchored" id="module-Chan"><a href="#module-Chan" class="anchor"></a><code><span><span class="keyword">module</span> Chan</span><span> = <a href="../../fuseau/Fuseau/Chan/index.html">Fuseau.Chan</a></span></code></div><div class="spec-doc"><p>Basic channels</p></div></div><h3 id="utils"><a href="#utils" class="anchor"></a>Utils</h3><div class="odoc-spec"><div class="spec module anchored" id="module-Exn_bt"><a href="#module-Exn_bt" class="anchor"></a><code><span><span class="keyword">module</span> Exn_bt</span><span> = <a href="../../fuseau/Fuseau/Exn_bt/index.html">Fuseau.Exn_bt</a></span></code></div><div class="spec-doc"><p>Exception with backtrace</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Time"><a href="#module-Time" class="anchor"></a><code><span><span class="keyword">module</span> Time</span><span> = <a href="../../fuseau/Fuseau/Time/index.html">Fuseau.Time</a></span></code></div><div class="spec-doc"><p>Time measurement</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Fiber"><a href="#module-Fiber" class="anchor"></a><code><span><span class="keyword">module</span> Fiber</span><span> = <a href="../../fuseau/Fuseau/Fiber/index.html">Fuseau.Fiber</a></span></code></div><div class="spec-doc"><p>Fibers.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-FLS"><a href="#module-FLS" class="anchor"></a><code><span><span class="keyword">module</span> FLS</span><span> = <a href="../../fuseau/Fuseau/FLS/index.html">Fuseau.FLS</a></span></code></div><div class="spec-doc"><p>Fiber-local storage.</p></div></div><h3 id="io-event-loop"><a href="#io-event-loop" class="anchor"></a>IO event loop</h3><div class="odoc-spec"><div class="spec exception anchored" id="exception-Inactive"><a href="#exception-Inactive" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Inactive</span></span></code></div><div class="spec-doc"><p>Exception raised when trying to perform operations on the scheduler after it's been disposed of</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Scheduler"><a href="#module-Scheduler" class="anchor"></a><code><span><span class="keyword">module</span> Scheduler</span><span> = <a href="../../fuseau/Fuseau/Scheduler/index.html">Fuseau.Scheduler</a></span></code></div><div class="spec-doc"><p>Scheduler that runs fibers.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Event_loop"><a href="#module-Event_loop" class="anchor"></a><code><span><span class="keyword">module</span> Event_loop</span><span> = <a href="../../fuseau/Fuseau/Event_loop/index.html">Fuseau.Event_loop</a></span></code></div></div><h3 id="resource-management"><a href="#resource-management" class="anchor"></a>Resource management</h3><div class="odoc-spec"><div class="spec module anchored" id="module-Resource_pool"><a href="#module-Resource_pool" class="anchor"></a><code><span><span class="keyword">module</span> Resource_pool</span><span> = <a href="../../fuseau/Fuseau/Resource_pool/index.html">Fuseau.Resource_pool</a></span></code></div><div class="spec-doc"><p>Resource pool.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Buf_pool"><a href="#module-Buf_pool" class="anchor"></a><code><span><span class="keyword">module</span> Buf_pool</span><span> = <a href="../../fuseau/Fuseau/Buf_pool/index.html">Fuseau.Buf_pool</a></span></code></div><div class="spec-doc"><p>A pool of buffers to reuse.</p></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Cancel_handle"><a href="#module-Cancel_handle" class="anchor"></a><code><span><span class="keyword">module</span> Cancel_handle</span><span> = <a href="../../fuseau/Fuseau/Cancel_handle/index.html">Fuseau.Cancel_handle</a></span></code></div></div><h3 id="io"><a href="#io" class="anchor"></a>IO</h3><h3 id="sleep"><a href="#sleep" class="anchor"></a>Sleep</h3><div class="odoc-spec"><div class="spec value anchored" id="val-sleep_s"><a href="#val-sleep_s" class="anchor"></a><code><span><span class="keyword">val</span> sleep_s : <span>float <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Put the current fiber to sleep for the amount of seconds.</p></div></div><h3 id="re-exports"><a href="#re-exports" class="anchor"></a>Re-exports</h3><div class="odoc-spec"><div class="spec exception anchored" id="exception-Timeout"><a href="#exception-Timeout" class="anchor"></a><code><span><span class="keyword">exception</span> </span><span><span class="exception">Timeout</span></span></code></div><div class="spec-doc"><p>Exception used for cancellation caused by timeout</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-await"><a href="#val-await" class="anchor"></a><code><span><span class="keyword">val</span> await : <span><span><span class="type-var">'a</span> <a href="../../fuseau/Fuseau/Fiber/index.html#type-t">Fiber.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p>Wait for the fiber to terminate, and return the result. If the fiber failed, this re-raises the exception.</p><p>This must be called from inside another fiber, which will be suspended if needed.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-try_await"><a href="#val-try_await" class="anchor"></a><code><span><span class="keyword">val</span> try_await : <span><span><span class="type-var">'a</span> <a href="../../fuseau/Fuseau/Fiber/index.html#type-t">Fiber.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="../../fuseau/Fuseau/Exn_bt/index.html#type-result">Exn_bt.result</a></span></span></code></div><div class="spec-doc"><p>Like <a href="#val-await"><code>await</code></a> but catches exceptions.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-cancel_after_s"><a href="#val-cancel_after_s" class="anchor"></a><code><span><span class="keyword">val</span> cancel_after_s : <span>float <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Cancel the current fiber after <code>delay</code> seconds, unless the fiber terminates first. The cancellation will use the <a href="#exception-Timeout"><code>Timeout</code></a> exception.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ev_timeout"><a href="#val-ev_timeout" class="anchor"></a><code><span><span class="keyword">val</span> ev_timeout : <span>float <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="../../fuseau/Fuseau/Event/index.html#type-t">Event.t</a></span></span></code></div><div class="spec-doc"><p><code>ev_timeout duration</code> is an event that resolves after <code>duration</code> seconds with a <code>Error Timeout</code> error</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ev_deadline"><a href="#val-ev_deadline" class="anchor"></a><code><span><span class="keyword">val</span> ev_deadline : <span>float <span class="arrow">&#45;&gt;</span></span> <span><span class="type-var">'a</span> <a href="../../fuseau/Fuseau/Event/index.html#type-t">Event.t</a></span></span></code></div><div class="spec-doc"><p><code>ev_deadline time</code> is an event that resolves at monotonic time <code>t</code> with a <code>Error Timeout</code> error</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-with_cancel_callback"><a href="#val-with_cancel_callback" class="anchor"></a><code><span><span class="keyword">val</span> with_cancel_callback : <span><span>(<span><a href="../../fuseau/Fuseau/Exn_bt/index.html#type-t">Exn_bt.t</a> <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p><code>let@ () = with_cancel_callback cb in &lt;e&gt;</code> evaluates <code>e</code> in a scope in which, if the current fiber is cancelled, <code>cb()</code> is called. If <code>e</code> returns without the fiber being cancelled, this callback is removed.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-spawn"><a href="#val-spawn" class="anchor"></a><code><span><span class="keyword">val</span> spawn : 
  <span><span class="optlabel">?name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?propagate_cancel_to_parent</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <a href="../../fuseau/Fuseau/Fiber/index.html#type-t">Fiber.t</a></span></span></code></div><div class="spec-doc"><p>Must be run from inside the scheduler's thread. Spawn a new computation. This fiber has an implicit parent, which is normally the currently running fiber (the one calling <a href="#val-spawn"><code>spawn</code></a>). If the parent fails or is cancelled, the resulting fiber will also be cancelled (parent to child).</p><ul class="at-tags"><li class="parameter"><span class="at-tag">parameter</span> <span class="value">propagate_cancel_to_parent</span> <p>if true (the default), if this fiber fails then the parent fiber will also fail (child to parent).</p></li></ul><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <a href="#exception-Inactive"><code>Inactive</code></a> <p>if the scheduler is inactive.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-spawn_from_anywhere"><a href="#val-spawn_from_anywhere" class="anchor"></a><code><span><span class="keyword">val</span> spawn_from_anywhere : 
  <span><span class="optlabel">?name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../fuseau/Fuseau/Scheduler/index.html#type-t">Scheduler.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <a href="../../fuseau/Fuseau/Fiber/index.html#type-t">Fiber.t</a></span></span></code></div><div class="spec-doc"><p>Spawn a task from anywhere, possibly from another thread. The task will run in a subsequent call to <code>run_iteration</code> in the scheduler's thread. Thread-safe, more costly than <a href="#val-spawn"><code>spawn</code></a>. Runs under the root switch.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <a href="#exception-Inactive"><code>Inactive</code></a> <p>if the scheduler is inactive.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-spawn_as_child_of"><a href="#val-spawn_as_child_of" class="anchor"></a><code><span><span class="keyword">val</span> spawn_as_child_of : 
  <span><span class="optlabel">?name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?propagate_cancel_to_parent</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../fuseau/Fuseau/Scheduler/index.html#type-t">Scheduler.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span><span class="type-var">_</span> <a href="../../fuseau/Fuseau/Fiber/index.html#type-t">Fiber.t</a></span> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <a href="../../fuseau/Fuseau/Fiber/index.html#type-t">Fiber.t</a></span></span></code></div><div class="spec-doc"><p>Spawn a fiber in the given parent fiber's scope. See <a href="#val-spawn"><code>spawn</code></a> for more details on the arguments</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-schedule_micro_task"><a href="#val-schedule_micro_task" class="anchor"></a><code><span><span class="keyword">val</span> schedule_micro_task : <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> unit)</span> <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p>Must be run from inside a <a href="../../fuseau/Fuseau/Scheduler/index.html#type-t"><code>Scheduler.t</code></a>'s thread. Schedules a microtask that will run in this tick. Be careful not to create infinite sequences of micro tasks that starve the IO loop!</p><p>These microtasks do not handle effects and should try their best to not raise exceptions. Only use them for very short amount of work.</p><p>Not thread-safe.</p><ul class="at-tags"><li class="raises"><span class="at-tag">raises</span> <a href="#exception-Inactive"><code>Inactive</code></a> <p>if the scheduler is inactive.</p></li></ul></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-yield"><a href="#val-yield" class="anchor"></a><code><span><span class="keyword">val</span> yield : <span>unit <span class="arrow">&#45;&gt;</span></span> unit</span></code></div><div class="spec-doc"><p><code>yield ()</code> returns control to the scheduler and checks for cancellation. This must be called from a fiber.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-get_scheduler"><a href="#val-get_scheduler" class="anchor"></a><code><span><span class="keyword">val</span> get_scheduler : <span>unit <span class="arrow">&#45;&gt;</span></span> <a href="../../fuseau/Fuseau/Scheduler/index.html#type-t">Scheduler.t</a></span></code></div><div class="spec-doc"><p>This returns the scheduler on which the caller runs. It must be called from inside a fiber.</p></div></div><h3 id="main-loop."><a href="#main-loop." class="anchor"></a>Main loop.</h3><p>This is the loop that runs both fibers, and the IO event loop, in an interspersed way.</p></details></div><h3 id="interop"><a href="#interop" class="anchor"></a>Interop</h3><div class="odoc-spec"><div class="spec value anchored" id="val-await_lwt"><a href="#val-await_lwt" class="anchor"></a><code><span><span class="keyword">val</span> await_lwt : <span><span><span class="type-var">'a</span> <a href="../../lwt/Lwt/index.html#type-t">Lwt.t</a></span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p>Like <a href="../../fuseau/Fuseau/index.html#val-await"><code>Fuseau.await</code></a> but on a Lwt promise.</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-spawn_as_lwt"><a href="#val-spawn_as_lwt" class="anchor"></a><code><span><span class="keyword">val</span> spawn_as_lwt : 
  <span><span class="optlabel">?name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><span class="optlabel">?propagate_cancel_to_parent</span>:bool <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <a href="../../lwt/Lwt/index.html#type-t">Lwt.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-spawn_as_lwt_from_anywhere"><a href="#val-spawn_as_lwt_from_anywhere" class="anchor"></a><code><span><span class="keyword">val</span> spawn_as_lwt_from_anywhere : 
  <span><span class="optlabel">?name</span>:string <span class="arrow">&#45;&gt;</span></span>
  <span><a href="../../fuseau/Fuseau/Scheduler/index.html#type-t">Scheduler.t</a> <span class="arrow">&#45;&gt;</span></span>
  <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span>
  <span><span class="type-var">'a</span> <a href="../../lwt/Lwt/index.html#type-t">Lwt.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-IO_lwt"><a href="#module-IO_lwt" class="anchor"></a><code><span><span class="keyword">module</span> <a href="IO_lwt/index.html">IO_lwt</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div><div class="spec-doc"><p>IO through Lwt's engine</p></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ev_read"><a href="#val-ev_read" class="anchor"></a><code><span><span class="keyword">val</span> ev_read : <span><a href="../../ocaml/Unix/index.html#type-file_descr">Unix.file_descr</a> <span class="arrow">&#45;&gt;</span></span> <span>bytes <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>int <a href="../../fuseau/Fuseau/Event/index.html#type-t">Event.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec value anchored" id="val-ev_write"><a href="#val-ev_write" class="anchor"></a><code><span><span class="keyword">val</span> ev_write : <span><a href="../../ocaml/Unix/index.html#type-file_descr">Unix.file_descr</a> <span class="arrow">&#45;&gt;</span></span> <span>bytes <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>int <span class="arrow">&#45;&gt;</span></span> <span>int <a href="../../fuseau/Fuseau/Event/index.html#type-t">Event.t</a></span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Iostream"><a href="#module-Iostream" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Iostream/index.html">Iostream</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><div class="odoc-spec"><div class="spec module anchored" id="module-Net"><a href="#module-Net" class="anchor"></a><code><span><span class="keyword">module</span> <a href="Net/index.html">Net</a></span><span> : <span class="keyword">sig</span> ... <span class="keyword">end</span></span></code></div></div><h3 id="main-loop"><a href="#main-loop" class="anchor"></a>Main loop</h3><div class="odoc-spec"><div class="spec value anchored" id="val-main"><a href="#val-main" class="anchor"></a><code><span><span class="keyword">val</span> main : <span><span>(<span>unit <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span>)</span> <span class="arrow">&#45;&gt;</span></span> <span class="type-var">'a</span></span></code></div><div class="spec-doc"><p>Run main loop, using the current <code>Lwt_engine.t</code>.</p></div></div></div></body></html>
